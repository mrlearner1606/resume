name: Generate PDF Resume with Cache

on:
  push:
    paths:
      - 'index.html'
  workflow_dispatch:

jobs:
  generate-pdf:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Setup Node.js environment
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Cache npm modules
      uses: actions/cache@v3
      with:
        path: ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-

    - name: Install Puppeteer
      run: npm install puppeteer@20.7.4

    - name: Generate PDF from index.html
      run: |
        node -e '
        const puppeteer = require("puppeteer");
        const path = require("path");

        (async () => {
          const browser = await puppeteer.launch({
            headless: true,
            args: ["--no-sandbox", "--disable-setuid-sandbox"]
          });

          const page = await browser.newPage();

          const filePath = `file://${path.resolve("./index.html")}`;
          await page.goto(filePath, { waitUntil: "networkidle0" });

          await page.emulateMediaType("print");
          await page.waitForTimeout(2000);

          await page.pdf({
            path: "Krishna-Resume.pdf",
            format: "A4",
            margin: {
              top: "15mm",
              right: "15mm",
              bottom: "15mm",
              left: "15mm"
            },
            printBackground: true,
            preferCSSPageSize: true
          });

          await browser.close();
          console.log("PDF generated successfully!");
        })();
        '

    - name: Commit and push PDF
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add Krishna-Resume.pdf
        git commit -m "Auto-update resume PDF [skip ci]" || echo "No changes to commit"
        git push
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
